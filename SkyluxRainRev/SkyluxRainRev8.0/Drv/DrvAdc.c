/*
 * DrvAdc.c
 *
 * Created: 01/05/2019 09:54:22
 *  Author: Vermeersch Stijn
 */ 
/**********************************************************************************************************************/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; V E R I F Y    C O N F I G U R A T I O N
;---------------------------------------------------------------------------------------------------------------------*/
/**********************************************************************************************************************/



/***********************************************************************************************************************
; I N C L U D E S
;---------------------------------------------------------------------------------------------------------------------*/
#include <peripheral_clk_config.h>
#include <utils.h>
#include <hal_init.h>
#include <hpl_gpio.h>
#include <hpl_gclk_base.h>
#include <hpl_pm_base.h>
#include <hal_adc_sync.h>
#include "utils.h"

#include "atmel_start_pins.h"
#include "DrvAdc.h"
/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   D E F I N I T I O N S   A N D   M A C R O S
;---------------------------------------------------------------------------------------------------------------------*/
/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   T Y P E D E F S
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   F U N C T I O N   P R O T O T Y P E S
;---------------------------------------------------------------------------------------------------------------------*/
void ADC_0_PORT_init(void);
void ADC_0_CLOCK_init(void);
/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   V A R I A B L E S
;---------------------------------------------------------------------------------------------------------------------*/
static struct adc_sync_descriptor ADC_0;
/**********************************************************************************************************************/

/***********************************************************************************************************************
; E X P O R T E D   V A R I A B L E S
;---------------------------------------------------------------------------------------------------------------------*/
/**********************************************************************************************************************/

/***********************************************************************************************************************
; L O C A L   F U N C T I O N S
;---------------------------------------------------------------------------------------------------------------------*/
void ADC_0_PORT_init(void)
{
	// Disable digital pin circuitry
	gpio_set_pin_direction(PA02, GPIO_DIRECTION_OFF);
	gpio_set_pin_function(PA02, PINMUX_PA02B_ADC_AIN0);
}

void ADC_0_CLOCK_init(void)
{
	_pm_enable_bus_clock(PM_BUS_APBC, ADC);
	_gclk_enable_channel(ADC_GCLK_ID, CONF_GCLK_ADC_SRC);
}
/**********************************************************************************************************************/

/***********************************************************************************************************************
; E X P O R T E D   F U N C T I O N S
;---------------------------------------------------------------------------------------------------------------------*/
void DrvAdc_0_init(const uint8_t ch)
{
	ADC_0_CLOCK_init();
	ADC_0_PORT_init();
	
	adc_sync_init(&ADC_0, ADC, (void *)NULL);
	adc_sync_set_reference(&ADC_0, 2);
	adc_sync_enable_channel(&ADC_0, ch);				//AIN
}
/*--------------------------------------------------------------------------------------------------------------------*/
uint16_t DrvAdc_0_read(void)
{
	uint8_t buffer[4];
	adc_sync_read_channel(&ADC_0, 0, buffer, 4);
	return (buffer[1] << 8) | buffer[0];
}
/*--------------------------------------------------------------------------------------------------------------------*/
/**********************************************************************************************************************/